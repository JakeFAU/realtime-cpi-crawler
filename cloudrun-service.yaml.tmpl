apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: crawler-api
spec:
  template:
    metadata:
      annotations:
        run.googleapis.com/vpc-access-connector: projects/${GCP_PROJECT}/locations/${GCP_REGION}/connectors/cr-us-east4
        run.googleapis.com/vpc-access-egress: private-ranges-only
        autoscaling.knative.dev/maxScale: "20"
    spec:
      serviceAccountName: main-sa-account@${GCP_PROJECT}.iam.gserviceaccount.com
      containers:
        - name: app
          image: ${APP_IMAGE}
          ports:
            - name: http1
              containerPort: 8080
          env:
            - name: GO_ENV
              value: production
            - name: CRAWLER_DATABASE_HOST
              value: ${CRAWLER_DATABASE_HOST}
            - name: CRAWLER_DATABASE_PORT
              value: "${CRAWLER_DATABASE_PORT}"
            - name: CRAWLER_DATABASE_USER
              value: ${CRAWLER_DATABASE_USER}
            - name: CRAWLER_DATABASE_NAME
              value: ${CRAWLER_DATABASE_NAME}
            - name: CRAWLER_DATABASE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: ${DB_PASSWORD_SECRET_NAME}
                  key: ${DB_PASSWORD_SECRET_VERSION}
            - name: CRAWLER_STORAGE_BACKEND
              value: ${CRAWLER_STORAGE_BACKEND}
          resources:
            limits: { cpu: "1", memory: 1Gi }

        - name: prom-sidecar
          image: "us-docker.pkg.dev/cloud-ops-agents-artifacts/cloud-run-gmp-sidecar/cloud-run-gmp-sidecar:1.3.0"
          env:
            # Match your appâ€™s metrics endpoint
            - name: RUN_MONITORING_SCRAPE_PORT
              value: "8080"
            - name: RUN_MONITORING_SCRAPE_PATH
              value: "/metrics"
            # Optional tuning
            - name: RUN_MONITORING_SCRAPE_INTERVAL
              value: "30s"
            # Optional static labels
            # - name: RUN_MONITORING_TARGET_LABELS
            #   value: "service=crawler-api,component=crawler"
          resources:
            limits: { cpu: "0.5", memory: 256Mi }
