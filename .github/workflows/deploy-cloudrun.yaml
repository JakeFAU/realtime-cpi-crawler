name: Build & Deploy (Cloud Run)

on:
  push:
    branches: [main]

permissions:
  contents: read
  id-token: write # for Workload Identity Federation
  packages: read

env:
  GCP_PROJECT: realtime-cpi
  GCP_REGION: us-east4
  GAR_REPOSITORY: realtime-cpi-docker # Artifact Registry repo name (docker)
  IMAGE_NAME: realtime-cpi-crawler
  SERVICE_NAME: crawler-api # Cloud Run service name
  # Resulting image: us-east4-docker.pkg.dev/$GCP_PROJECT/$GAR_REPOSITORY/$IMAGE_NAME:$GITHUB_SHA

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-go@v6
        with:
          go-version: "1.25"
          cache: true

      - name: Build
        run: go build -v ./...

      - name: Test (race)
        run: go test -race -v ./...

      - name: Lint
        uses: golangci/golangci-lint-action@v8
        with:
          version: latest
          args: --timeout=5m

  build-and-push:
    needs: [build-test]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      security-events: write
    outputs:
      # --- THIS IS THE FIX ---
      # We now output the full image name using the unique digest (SHA)
      # This avoids any race conditions with the 'latest' tag.
      image: ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT }}/${{ env.GAR_REPOSITORY }}/${{ env.IMAGE_NAME }}@${{ steps.build_and_push.outputs.digest }}
    steps:
      - uses: actions/checkout@v5

      # Auth to GCP via WIF (no JSON keys)
      - name: Auth via Workload Identity Federation
        id: auth
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_DEPLOY_SA }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT }}

      # Docker auth to Artifact Registry in region
      - name: Configure Docker for GAR
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      # Standardized tags/labels for provenance
      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT }}/${{ env.GAR_REPOSITORY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,enable=true,priority=100
            type=ref,event=tag
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      # Layer caching to speed rebuilds
      - name: Build & Push
        # --- THIS IS THE FIX ---
        # We add an ID here so we can reference its 'outputs.digest' above
        id: build_and_push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false # (set true if you want SLSA provenance)

  deploy:
    needs: [build-and-push]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      security-events: write
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: actions/checkout@v5

      - name: Auth via Workload Identity Federation
        id: auth
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_DEPLOY_SA }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT }}

      - name: Deploy (multi-container with GMP sidecar)
        id: deploy
        env:
          # This 'IMAGE_OUT' will now correctly receive the unique digest
          IMAGE_OUT: ${{ needs.build-and-push.outputs.image }}
          GCP_PROJECT: ${{ env.GCP_PROJECT }}
          GCP_REGION: ${{ env.GCP_REGION }}
          CRAWLER_DATABASE_HOST: ${{ secrets.DB_HOST }}
          CRAWLER_DATABASE_PORT: ${{ secrets.DB_PORT }}
          CRAWLER_DATABASE_USER: ${{ secrets.DB_USER }}
          CRAWLER_DATABASE_NAME: ${{ secrets.DB_NAME }}
          DB_PASSWORD_SECRET_NAME: "real-cpi-db-secret"
          DB_PASSWORD_SECRET_VERSION: "1"
          CRAWLER_STORAGE_BACKEND: "gcs"
        run: |
          # Assign the value from IMAGE_OUT to the APP_IMAGE var used by the template
          export APP_IMAGE="${IMAGE_OUT}"

          # These other variables are already set by the step's 'env' block,
          # but exporting them ensures envsubst can access them.
          export GCP_PROJECT GCP_REGION \
            CRAWLER_DATABASE_HOST CRAWLER_DATABASE_PORT \
            CRAWLER_DATABASE_USER CRAWLER_DATABASE_NAME \
            DB_PASSWORD_SECRET_NAME DB_PASSWORD_SECRET_VERSION \
            CRAWLER_STORAGE_BACKEND

          # Debug line: This will now print the image with its unique @sha256:... digest
          echo "--- Deploying Image: $APP_IMAGE"
          echo "--- To Project: $GCP_PROJECT"

          envsubst < cloudrun-service.yaml.tmpl > service.yaml

          gcloud run services replace service.yaml \
            --project "${GCP_PROJECT}" \
            --region "${GCP_REGION}"

          URL=$(gcloud run services describe crawler-api --region "${GCP_REGION}" --format='value(status.url)')
          echo "url=$URL" >> "$GITHUB_OUTPUT"

    concurrency:
      group: cloudrun-${{ github.ref }}
      cancel-in-progress: false
